# 基于对抗领域泛化的旋转机械跨域诊断（ADIG）说明文档
##1. 项目学习须知
###1.1上传项目注意事项
- 提出的新方法程序介绍（程序备注）最好多一些，同时说明文档中标明出处；  
- 每个.py程序文件都可以独立运行最好可观察调试结果（根据情况而定）；  
- 包含可直接加载数据集，如果数据集不大可以直接放入项目文件中。
###1.2需要读的参考文献
- 《基于对抗学习的旋转机械跨域故障诊断研究》——第四章  
- 《Generative Adversarial Nets》  
- 《Domain-Adversarial Training of Neural Networks》  
- 《Unsupervised Domain Adaptation by Backpropagation》
###1.3使用的数据集
- 苏州大学数据集SBDS  
 - 数据集四种工况文件名：SBDS 0K 10.mat、SBDS 1K 10.mat、SBDS 2K 10.mat、SBDS 3K 10.mat。  
 - 训练集尺寸：size = [4000, 1, 32, 32]  
 - 测试集尺寸：size = [2000, 1, 32, 32]  
- 山东科技大学数据集SDUS  
 - 数据集四种工况文件名：SUST 500.mat、SUST 1000.mat、SUST 1500.mat、SUST 2000.mat。  
 - 训练集尺寸：size = [1000, 1, 32, 32]  
 - 测试集尺寸：size = [2000, 1, 32, 32]
##2.项目概述
###2.1 解决的问题
- 在复杂的工业场景下，在设备工况未知时基于域适应的方法通常会失效，即在模型训练期间无法获得目标数据来进行工况的迁移；  
- 传统 DA 诊断中忽略了对多个源域信号的使用，仅来自两个领域的故障信号只能将知识从单个源域推广到特定的目标域。这些模型不可避免地在单个域上过拟合，从而可能导致诊断模型的泛化能力面对新目标域发生退化，因此模型不足以确保学习到具备域不变性的故障特征；  
- 当诊断模型训练无法获取目标域数据时，即目标域缺少样本时会导致问题更加恶化；  
- 因此，有必要利用多个领域的通用诊断知识来实现泛化的诊断。为消除对目标域数据的依赖性，提出了一种通用的域泛化诊断框架，即对抗域不变泛化 (Adversarial Domain-Invariant Generalization, ADIG)。 
###2.2 创新点
- 通过多个可用的源域数据来学习未知目标域的广义故障特征表示，“未知”意味着目标数据在模型训练过程中不可用；  
- 将特征提取器施（E)加实例标准化 (Instance Normalization，IN)策略；  
- 将域分类器(D)施加谱标准化(Spectral Normalization, SN)策略；  
- 为了动态平衡多任务损失，提出了一个权重系数学习机制来实现自适应权重。
###2.3 用的核心技术
- 对抗（GAN）训练技术；  
- 领域自适应技术；  
- 梯度反转GRL技术。  
- ADIG 利用多个可用的领域数据，通过特征提取器和领域分类器之间的对抗学习来学习跨领域不变知识。同时，**故障分类器将源域相关的知识进行泛化，对不可见但相关的目标域信号进行诊断。**此外，提出了自定义的特征标准化 IN、SN 和自适应权重策略，以提高诊断性能。
###2.4 所做的贡献
- 介绍了基于 DG 的跨域故障诊断，并提出了一种通用域回归框架ADIG。ADIG设计了3个模块，分别为用于降低经验风险的故障分类器C，估计对称差异假设空间距离的领域分类器D，以及通过降低特征间对称差异假设空间距离来提取域不变特征的特征提取器E。具体贡献如下：  
- 首先提出了一种新颖的诊断理论，即通用的域泛化诊断理论，可以诊断未知目标域的故障模式。为了诊断工况未知的故障，实现跨域泛化诊断，提供一种新颖的域泛化诊断框架 ADIG。  
- ADIG 通过特征提取器，域分类器和故障分类器三个模块来诊断未知的域故障。通过特征提取器和域分类器的对抗训练，可以从多个领域学习领域不变和故障相关的知识，并可以充分利用域不变知识来减小对目标域数据的依赖。  
- 定制的 IN 和 SN 策略实现跨域特征标准化，促进训练，以学习域不变特征并将其迁移到未知的目标域，提升域泛化诊断性能。此外，自适应权重策略在多任务学习期间学习损失之间的权重，不仅节省手动调超参的工序，也提升了模型的性能。   
- 基于两个案例研究进行综合实验评估 ADIG 的性能。可视化的特征表示体现了所提出方法的内在聚类效果，结果显示，ADIG 可以将知识推广到未知的目标领域，从而证明了 ADIG 在实际工业应用中的潜力和优越性，因此 ADIG 可以成为一个针对未知故障的诊断模型范例 。
##3. ADIG项目程序文件介绍
###3.1 项目文件包含的函数或类介绍
- **`cnn_model.py`**  
 - `conv1x1`:逐点卷积，调整通道数量  
 - `snconv1x1`:逐点卷积施加谱归一化（Spectral Normalization）  
 - `CNNmodel`:诊断模型
- **`readdata.py`**  
 - `load_data`：原始数据读取  
 - `norm`：可以采用sklearn中的库  
 - `sampling`： 从序列中采样样本  
 - `readdata`：类实现读取-数据预处理-采样的工作流，构建一个样本  
 - `dataset`：在readdata的基础上重复执行readdate的流，来构建数据集  
 - `main`： input数据集地址
- **`diagnosis_demo_cnn.py`**
 -  `Diagnosis`:诊断模型
 -  `caculate_acc`:计算准确率
 -  `fit`:诊断函数
 -  `s_evaluation`:评估源域数据集
 -  `t_evaluation`:评估目标域数据集
 -  `save`:保存模型和其参数
 -  `save_prediction`:保存预测标签值
 -  `save_his`:保存训练历史数据
 -  `load`:加载模型
 -  `data_reader`:从mat文件或者其它类型文件中读取数据
 -  `if __name__ == '__main__':`:主函数
- **`data_loader.py`**
 - `Loader_single`:加载单领域数据集，一般用于加载目标域
 - `Loader_unif_sampling`:加载多领域数据集，可用于加载3源域数据集
 - `Loader_unif_sampling_DA`:加载多领域数据集，可用于加载4个域数据集
 - `if __name__ == '__main__':`:主函数
- **`AutomaticWeightedLoss.py`**
 - `AutomaticWeightedLoss`:自动加权多任务损失
 - `__init__(num, ini)`:初始化参数
 	   - num:需要自适应权重的损失数量
 	   - ini:初始化权重，为超参数，可以调节
 - `forward`:前向传播函数
       - 输入参数：故障分类损失与判别器损失之和
       - 返回参数：自适应加权后的损失
- **`Self_attention.py`**
 - `Self_Attn`:自注意层
 - `forward`:前向传播
      - 输入参数：特征提取器提取的特征向量
      - 返回参数：out为自注意值+输入特征值
###3.2 诊断模型说明
- 包含的层结构
 - Conv2d：3x3或1x1二维卷积层
 - snconv2d：施加有谱归一化的3x3或1x1二维卷积层
 - InstanceNorm2d：实例正则化层
 - LeakyReLU：激活层
 - Dropout：辍学层
 - AvgPool2d：平均池化层
 - GRL：梯度反转层
 - Attention_layer：自注意层
- forward传入参数
    - `x`：输入数据
- forward返回参数
    - `c`：故障分类预测标签
    - `d`：领域分类标签
###3.3 ADIG诊断主程序说明
- 可调整的超参数
    - 学习率：lr=0.001
    - 小批量大小：batch_size=64
    - 源域数量：domains=3
    - 权重衰减：weight_decay=0.0001
    - 迭代次数：epoches=50
- 损失函数
    - `loss_function`：交叉熵损失函数，用于计算模型预测输出与真实标签的损失，本文中包含故障分类损失和领域分类损失。
    - `balanceloss`：自适应权重损失，用于平衡故障分类损失和领域判别损失的权重。


